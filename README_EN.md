# Introduction

This is a pure ES module focusing on **static blog** scenario **Markdown file batch processing**, only supports Nodejs, batch Markdown data in a specific format stored in JSON files, for blogging scenarios, to provide indexing, paging features.

Documents list:

- [Chinese](/README.md)
- [English](/README_EN.md)

# Features

Implemented features:

- Data query:
  - Blog details: batch parse markdown files (support Front Matter parsing), generate `post_[hash]_[basename].json`;
  - Blog index: generate `posts.json`, containing basic information of all blog posts;
  - Blog summary: long content will be summarized by line or specified special tags (e.g. `<! ---more-->`) to truncate the summary;
  - Paging: split the data in `posts.json` into several JSON files to generate `posts_[page].json`;
- Performance optimization:
  - Skips files that have already been processed;
  - On-demand loading is possible with the help of the paging feature;
  - Streaming reads and writes to improve the efficiency of processing long blogs;
- Type checking: complete Typescript type definition, good code hints;

TODO List:

- JSON file compression/decompression;
- Support Tag/Category function;

# Installation

```bash
npm install oaks-post
```

# Usage

Invoke the following:

```js
import { PostsManager } from "oaks-post";

const yourMarkdownDirectory = "markdown";
const yourJsonDirectory = "json";

const posts = new PostsManager({
  baseUrl: "https://neil-ji.github.io/",
  inputDir: yourMarkdownDirectory,
  outputDir: yourJsonDirectory,
  descending: true,
  maxItems: 3,
});

posts.start();
```

For example, the `markdown/Hello Oaks.md` file looks like this:

```markdown
---
title: Hello Oaks
date: 2023-07-25 14:40:00
tag:
  - introduce
  - oaks-post
---

# Oaks Introduction

This is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.

This is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.

This is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.

This is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.

This is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.
```

Generate the blog details `json\post_a46fd04a_Hello Oaks.json` file as follows:

```json
{
  "frontMatter": {
    "title": "Hello Oaks",
    "date": "2023-07-25T14:40:00.000Z",
    "tag": ["introduce", "oaks-post"]
  },
  "content": "\r\n## Oaks Introduction\r\n\r\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\r\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\r\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\r\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\r\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario."
}
```

Generate the blog index file `json_database/posts.json`:

```json
{
  "buildTime": "2024-02-17T06:14:11.288Z",
  "posts": [
    {
      "url": "https:/neil-ji.github.io/json/post_a46fd04a_Hello Oaks.json",
      "hash": "a46fd04a",
      "frontMatter": {
        "title": "Hello Oaks",
        "date": "2023-07-25T14:40:00.000Z",
        "tag": ["introduce", "oaks-post"]
      },
      "excerpt": "## Oaks Introduction\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario."
    }
  ]
}
```

Generate the paging file `json_database/posts_1.json`:

```json
{
  "current": 1,
  "posts": [
    {
      "url": "https:/neil-ji.github.io/json/post_a46fd04a_Hello Oaks.json",
      "hash": "a46fd04a",
      "frontMatter": {
        "title": "Hello Oaks",
        "date": "2023-07-25T14:40:00.000Z",
        "tag": ["introduce", "oaks-post"]
      },
      "excerpt": "## Oaks Introduction\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario.\r\n\nThis is a pure ES module focused on 'Markdown file batch processing' in the static blog scenario."
    }
  ]
}
```

# Blog Details

Each Markdown file will generate a corresponding blog details file, named `post_[hash]_[basename].json`.

1. hash: 8-bit hexadecimal number hash value, generated by Markdown file name + file content, using non-cryptographic hash function MurmurHash3, faster execution. 2. basename: Markdown file name and hash value, generated by Markdown file content, using non-cryptographic hash function MurmurHash3, faster execution;
2. basename: Markdown file name;

The blog details attributes are defined as follows:

1. frontMatter: key-value pairs generated after parsing Front Matter, generally used for defining blog metadata, it is a YAML syntax block identified by `---`;
2. content: Markdown main text;

# Blog Summary

Flexible control of the blog summary interception rules via `excerptOptions`, as follows.

## Intercept summaries by number of lines

Intercepting by lines is the default behavior, and Markdown multi-line block syntax will be recognized as 1 line.

An example of intercepting the first 5 lines is shown below:

```ts
const posts = new PostsManager({
  // ...others
  excerptOptions: {
    rule: PostsExcerptRule.ByLines,
    lines: 5,
  },
});
```

## Intercept summaries by specified tags

Supports intercepting content according to custom tags in Markdown files. If you select this rule, you can leave out the tags, and the interceptor tags will default to `<! ---more-->`, which is a popular way to write hexo.

Of course, you can also provide any customized tags you want, but it is recommended to use Markdown comment syntax to define tags.

```ts
const posts = new PostsManager({
  // ...others
  excerptOptions: {
    rule: PostsExcerptRule.CustomTag,
    tag: "<!--YOUR_TAG-->",
  },
});
```

Markdown files use tags as follows:

```markdown
Hello
Hello

<!--YOUR_TAG-->

Hello
Hello
Hello
Hello
Hello
Hello
```

The JSON data generated:

```json
{
  "buildTime": "2024-02-17T06:14:11.288Z",
  "posts": [
    {
      // ... . others
      "excerpt": "Hello\nHello\n\n"
    }
  ]
}
```

# Blog Index

This file is used in the scenario of getting the full amount of blog data, specifically, `oaks-post` collects all the Markdown processed JSON data and stores it uniformly in the `posts.json` file, which is similar to the role of a table in a database, providing an index of all the blog details.

The properties are defined as follows:

```ts
interface Posts {
  buildTime: Date;
  posts: PostItem[];
}
interface PostItem {
  hash?: string;
  url?: string;
  frontMatter?: PostFrontMatter;
  excerpt?: string;
}
interface PostFrontMatter {
  [key: string]: any;
}
```

# Blog Paging

Enable paging via `maxItems` when you need to page or scroll data, default **no paging**, default value will be used when passing illegal data 10.

Pagination file naming format is `posts_[page].json`, page stands for page number, properties are defined as follows:

```ts
interface PostsPage {
  current: number;
  posts: PostItem[];
  prev?: string;
  next?: string;
}
```

# Configuration Parameters

You can pass in an object to control some of the PostsManager's behavior, which has the following TS type definition:

```ts
interface PostsManagerOptions {
  baseUrl?: string;
  inputDir: string;
  outputDir: string;
  descending?: boolean;
  excerptOptions?: PostsExcerptOptions;
  maxItems?: number;
}

interface PostsExcerptOptions {
  rule: PostsExcerptRule;
  lines?: number;
  tag?: string;
}

enum PostsExcerptRule {
  ByLines = 1,
  CustomTag = 2,
}
```

The following are the meanings of the fields:

- `inputDir: string`: required, you can pass relative or absolute path, the relative path will be parsed by default with `process.cwd()` as the reference, it represents the directory where your markdown file is located;
- `outputDir: string`: required, the parsing rule is the same as `inputDir`, it represents the directory where the json file output by `oaks-post` is stored;
- `baseUrl?: string`: optional, default is empty string `""`, it will be used as the url prefix of each post in posts.json;
- `descending?: boolean`: optional, defaults to `false` (in ascending chronological order), which determines the order of the posts array in `posts.json`;
- `excerptOptions?: object` optional:
  - `rule: PostsExcerptRule`: required, enumeration type, optional values as follows:
    - `PostsExcerptRule.ByLines`: default to intercept markdown content by lines.
    - CustomTag`: optionally capture markdown content by custom tag.
  - `lines?: number`: optional, specify the number of lines to be intercepted, blank lines will not be counted, code block will be treated as one line.
  - `tag?: string`: optionally, intercept to the specified tag, default is `<! ---more-->`, this is `hexo` generic summary intercept tag.
- `maxItems?: number`: optional, specify this value to enable paging, paging is not enabled by default, default value 10 will be used if less than 0;
